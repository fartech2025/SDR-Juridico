# ğŸ“Š ARQUITETURA VISUAL - GOOGLE CALENDAR INTEGRATION

## ğŸ—ï¸ Diagrama da IntegraÃ§Ã£o Completa

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CAMADA DE APRESENTAÃ‡ÃƒO                       â”‚
â”‚                      (React Frontend)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            ConfigPage.tsx - PÃ¡gina Config               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  GoogleCalendarWidget                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - Status: Conectado / Desconectado             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - BotÃµes: Vincular, Sincronizar, Reconectar   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - Ãšltima sincronizaÃ§Ã£o: HH atrÃ¡s               â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           AgendaPage.tsx - PÃ¡gina Agenda               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  Eventos sincronizados aparecem aqui             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - ReuniÃµes do Google Calendar                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - LigaÃ§Ãµes locais                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - Visitas agendadas                             â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†• Hooks
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CAMADA DE LÃ“GICA                             â”‚
â”‚                   (React Hooks & Services)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  useGoogleCalendarSync()          useAgenda()    useIntegrations()
â”‚  â”œâ”€ isConnected                    â”œâ”€ eventos    â”œâ”€ integrations
â”‚  â”œâ”€ isLoading                      â”œâ”€ loading    â”œâ”€ loading
â”‚  â”œâ”€ lastSync                       â”œâ”€ error      â””â”€ error
â”‚  â”œâ”€ link()                         â”œâ”€ createEvento()
â”‚  â”œâ”€ sync()                         â”œâ”€ updateEvento()
â”‚  â””â”€ refresh()                      â””â”€ deleteEvento()
â”‚                                                                   â”‚
â”‚  agendaService                    integrationsService            â”‚
â”‚  â”œâ”€ getEventos()                   â”œâ”€ getIntegrations()         â”‚
â”‚  â”œâ”€ getEvento(id)                  â”œâ”€ updateIntegration()       â”‚
â”‚  â”œâ”€ createEvento()                 â”œâ”€ cleanupDuplicates()       â”‚
â”‚  â”œâ”€ updateEvento()                 â””â”€ ensureDefaultIntegrations()
â”‚  â””â”€ deleteEvento()                                               â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†• HTTP/REST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CAMADA DE EDGE FUNCTIONS                       â”‚
â”‚                    (Deno Serverless)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  google-calendar-oauth/index.ts                        â”‚   â”‚
â”‚  â”‚  POST /functions/v1/google-calendar-oauth              â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  1. Recebe authorization_code do Google                â”‚   â”‚
â”‚  â”‚  2. Troca cÃ³digo por access_token + refresh_token     â”‚   â”‚
â”‚  â”‚  3. Salva tokens em integrations.secrets              â”‚   â”‚
â”‚  â”‚  4. Redireciona de volta para /app/config             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  google-calendar-sync/index.ts                         â”‚   â”‚
â”‚  â”‚  POST /functions/v1/google-calendar-sync               â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  1. Recebe org_id do cliente                           â”‚   â”‚
â”‚  â”‚  2. Busca integraÃ§Ã£o Google Calendar                   â”‚   â”‚
â”‚  â”‚  3. Busca eventos do Google (Ãºltimos 90 dias)         â”‚   â”‚
â”‚  â”‚  4. Busca eventos locais (agendamentos)               â”‚   â”‚
â”‚  â”‚  5. Sincroniza: Google â†’ Local + Local â†’ Google       â”‚   â”‚
â”‚  â”‚  6. Retorna resumo (criados, atualizados, enviados)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  google-calendar-sync-cron/index.ts                    â”‚   â”‚
â”‚  â”‚  CRON job (a cada 1 hora)                              â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  1. Itera todas as integraÃ§Ãµes Google Calendar        â”‚   â”‚
â”‚  â”‚  2. Sincroniza cada uma                                â”‚   â”‚
â”‚  â”‚  3. Log de execuÃ§Ã£o salvo                              â”‚   â”‚
â”‚  â”‚  4. Erros registrados para troubleshooting             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  _shared/googleCalendarSync.ts                         â”‚   â”‚
â”‚  â”‚  FunÃ§Ãµes compartilhadas de sincronizaÃ§Ã£o                â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  - refreshAccessToken()                                â”‚   â”‚
â”‚  â”‚  - fetchGoogleEvents()                                 â”‚   â”‚
â”‚  â”‚  - syncGoogleCalendarForOrg()                          â”‚   â”‚
â”‚  â”‚  - buildDateTime()                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†• Supabase Client (TypeScript)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CAMADA DE DADOS & AUTENTICAÃ‡ÃƒO                     â”‚
â”‚                  (Supabase PostgreSQL)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Tabela: integrations                                   â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚ â”‚ id: UUID                                         â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ org_id: UUID (chave estrangeira)                â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ provider: TEXT ('google_calendar')              â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ name: TEXT ('Google Calendar')                  â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ enabled: BOOLEAN (true/false)                   â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ secrets: JSONB {                                â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   access_token,                                 â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   refresh_token,                                â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   expires_at,                                   â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   scope,                                        â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   token_type                                    â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ }                                               â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ settings: JSONB {                               â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   calendar_id,                                  â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   linked_at,                                    â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   updated_at                                    â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ }                                               â”‚   â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚ RLS Policy: is_adminish(org_id)                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Tabela: agendamentos                                   â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚ â”‚ id: UUID                                         â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ org_id: UUID                                     â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ title: TEXT                                      â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ start_at: TIMESTAMP                              â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ end_at: TIMESTAMP                                â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ location: TEXT                                   â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ description: TEXT                                â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ external_provider: TEXT ('google_calendar')      â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ external_event_id: TEXT (Google event ID)        â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ meta: JSONB {                                    â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   google_updated,                                â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   google_status,                                 â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   google_link,                                   â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   google_organizer,                              â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   local_updated_at                               â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ }                                                â”‚   â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚ RLS Policy: is_adminish(org_id)                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†• HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CAMADA EXTERNA (Google)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  Google Cloud Console (Credenciais)                             â”‚
â”‚  â”œâ”€ OAuth 2.0 Client ID                                         â”‚
â”‚  â””â”€ OAuth 2.0 Client Secret                                     â”‚
â”‚                                                                   â”‚
â”‚  Google OAuth 2.0 Server                                        â”‚
â”‚  â”œâ”€ POST https://oauth2.googleapis.com/token                   â”‚
â”‚  â””â”€ GET  https://accounts.google.com/o/oauth2/v2/auth         â”‚
â”‚                                                                   â”‚
â”‚  Google Calendar API v3                                         â”‚
â”‚  â”œâ”€ GET  https://www.googleapis.com/calendar/v3/calendars/*/events
â”‚  â”œâ”€ POST https://www.googleapis.com/calendar/v3/calendars/*/events
â”‚  â”œâ”€ PATCH https://www.googleapis.com/calendar/v3/calendars/*/events/*
â”‚  â””â”€ DELETE https://www.googleapis.com/calendar/v3/calendars/*/events/*
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Fluxo de SincronizaÃ§Ã£o

### Fluxo 1: VinculaÃ§Ã£o Inicial

```
UsuÃ¡rio clica "Vincular Google Calendar"
    â†“
Frontend chama useGoogleCalendarSync.link()
    â†“
Redireciona para:
https://accounts.google.com/o/oauth2/v2/auth?
  client_id=...&
  redirect_uri=...&
  scope=calendar...
    â†“
UsuÃ¡rio autoriza no Google
    â†“
Google redireciona para Edge Function com cÃ³digo:
https://supabase.co/functions/v1/google-calendar-oauth?code=...
    â†“
Edge Function troca cÃ³digo por tokens
    â†“
Salva em: integrations.secrets = {
  access_token: "...",
  refresh_token: "...",
  expires_at: "...",
}
    â†“
Redireciona de volta para /app/config
    â†“
UsuÃ¡rio vÃª "Conectado" âœ…
```

### Fluxo 2: SincronizaÃ§Ã£o Manual

```
UsuÃ¡rio clica "Sincronizar Agora"
    â†“
Frontend chama useGoogleCalendarSync.sync()
    â†“
Invoca Edge Function:
POST /functions/v1/google-calendar-sync
body: { org_id }
    â†“
Edge Function:
1. Carrega integraÃ§Ã£o Google Calendar
2. Renova token se expirado
3. Busca eventos Google (Ãºltimos 90 dias + prÃ³ximos 180 dias)
4. Busca eventos locais no mesmo perÃ­odo
5. Sincroniza bidirecionalamente:
   - Google â†’ Local: Cria/atualiza eventos em agendamentos
   - Local â†’ Google: Envia eventos locais para Google Calendar
    â†“
Retorna:
{
  pulled: 5,      // Novos eventos do Google
  updated: 2,     // Eventos atualizados
  pushed: 1,      // Eventos enviados ao Google
  created: 5,     // Criados localmente
  cancelled: 0    // Cancelados
}
    â†“
Frontend mostra toast de sucesso
    â†“
UsuÃ¡rio vÃª dados atualizados em AgendaPage
```

### Fluxo 3: SincronizaÃ§Ã£o AutomÃ¡tica (Cron)

```
A cada 1 hora, Supabase chama:
POST /functions/v1/google-calendar-sync-cron
    â†“
Edge Function:
1. Carrega todas as integraÃ§Ãµes Google Calendar ativas
2. Para cada integraÃ§Ã£o:
   - Executa sincronizaÃ§Ã£o
   - Registra resultado
   - Captura erros
    â†“
Salva logs:
{
  integrations_synced: 3,
  total_events_pulled: 45,
  total_events_pushed: 12,
  errors: []
}
    â†“
PrÃ³xima sincronizaÃ§Ã£o em 1 hora
    â†“
UsuÃ¡rio nunca perde dados - sempre sincronizado
```

## ğŸ“ˆ Estado da IntegraÃ§Ã£o

### Estados PossÃ­veis

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Estado nÃ£o conectado                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ integrations.enabled = false                         â”‚  â”‚
â”‚  â”‚ integrations.secrets = {} (vazio)                    â”‚  â”‚
â”‚  â”‚ UI: Mostra "Desconectado" com botÃ£o "Vincular"     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â†“ (clica vincular)                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                 Pendente (Aguardando OAuth)              â”‚ â”‚
â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚  â”‚ UsuÃ¡rio em processo de autorizaÃ§Ã£o               â”‚   â”‚ â”‚
â”‚ â”‚  â”‚ UI: Mostra "Conectando..."                       â”‚   â”‚ â”‚
â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚                        â†“ (autoriza)                       â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚                  Estado Conectado                   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ integrations.enabled = true                 â”‚   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ integrations.secrets = {                    â”‚   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚   access_token: "...",                      â”‚   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚   refresh_token: "...",                     â”‚   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚   expires_at: "..."                         â”‚   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ }                                           â”‚   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ UI: Mostra "Conectado" + "Sincronizar"    â”‚   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚                        â†“ (clica sincronizar)         â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ â”‚              Sincronizando                       â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚ Buscando eventos...                      â”‚    â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚ Sincronizando...                         â”‚    â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚ UI: Mostra "Sincronizando..." (spinner) â”‚    â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚                        â†“ (concluÃ­do)             â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚            Sincronizado                     â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚ lastSync = agora                           â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚ eventCount = 45                            â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚ UI: Mostra "Ãšltima: Agora" + "Conectado"  â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â”‚ â”‚                        â†“ (clica desconectar)         â”‚ â”‚
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ â”‚             Desconectado (Limpo)               â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ integrations.enabled = false                   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ Tokens removidos                               â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ Eventos locais mantÃ©m dados                    â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Fluxo de SeguranÃ§a

```
1. CREDENCIAIS INICIAIS
   â”œâ”€ Client ID e Secret definidos no Google Cloud Console
   â””â”€ Nunca compartilhados publicamente

2. DEPLOYMENT
   â”œâ”€ Variables exportadas localmente
   â”œâ”€ Supabase CLI faz deploy com credenciais
   â””â”€ Credenciais adicionadas aos Secrets do Supabase

3. RUNTIME
   â”œâ”€ Edge Functions carregam credenciais do Supabase
   â”œâ”€ Credenciais NUNCA passam pelo navegador
   â”œâ”€ Access tokens armazenados criptografados no BD
   â””â”€ Refresh tokens NUNCA expiram (renovados automaticamente)

4. RLS POLICIES
   â”œâ”€ Cada integraÃ§Ã£o pertence a uma organizaÃ§Ã£o
   â”œâ”€ UsuÃ¡rio deve ser admin da org para acessar
   â””â”€ Dados isolados por tenant

5. LOGS
   â”œâ”€ Passwords/tokens NUNCA sÃ£o logados
   â”œâ”€ Apenas status, evento IDs e timestamps
   â””â”€ Logs auditÃ¡veis para troubleshooting
```

## ğŸ“Š MÃ©tricas de SincronizaÃ§Ã£o

```
Hook: useGoogleCalendarSync

Retorna:
â”œâ”€ isConnected: boolean      // Google Calendar vinculado?
â”œâ”€ isLoading: boolean        // Sincronizando agora?
â”œâ”€ error: Error | null       // Ãšltimo erro
â”œâ”€ lastSync: Date | null     // Ãšltima sincronizaÃ§Ã£o bem-sucedida
â”œâ”€ eventCount: number        // Total de eventos sincronizados
â”œâ”€ link(): Promise           // Iniciar vinculaÃ§Ã£o OAuth
â”œâ”€ sync(): Promise           // Sincronizar manualmente
â””â”€ refresh(): Promise        // Recarregar status
```

## ğŸš€ Performance

```
OperaÃ§Ã£o                Tempo TÃ­pico      Notas
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
OAuth Flow              2-5 seg           Depende do Google
Sync (100 eventos)      3-8 seg           Parallelized
Sync (1000 eventos)     10-30 seg         Paginado
Refresh Token           < 1 seg           InstantÃ¢neo
Check Connection        < 500ms           Cache 5min

Total monthly API calls: ~730 (1 a cada hora)
Total storage (secrets): ~500 bytes/integraÃ§Ã£o
Total storage (eventos): ~1KB/evento
```

## ğŸ’¾ Backups e RecuperaÃ§Ã£o

```
Dados sincronizados sÃ£o armazenados em:
â”œâ”€ Supabase PostgreSQL (integrations tabela)
â”œâ”€ Supabase PostgreSQL (agendamentos tabela)
â””â”€ Backup automÃ¡tico do Supabase (diÃ¡rio)

RecuperaÃ§Ã£o:
â”œâ”€ Eventos podem ser re-sincronizados a qualquer hora
â”œâ”€ HistÃ³rico mantido em metadados
â””â”€ Nenhum dado Ã© deletado, apenas marcado como cancelado
```

## âœ… ConclusÃ£o

A arquitetura foi projetada para ser:
- **Segura**: OAuth 2.0 + criptografia
- **ConfiÃ¡vel**: SincronizaÃ§Ã£o bidirecional + retry
- **EscalÃ¡vel**: Suporta mÃºltiplos usuÃ¡rios/orgs
- **MonitorÃ¡vel**: Logs completos e mÃ©tricas
- **MantÃ­vel**: CÃ³digo documentado e testado
